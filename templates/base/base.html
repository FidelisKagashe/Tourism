<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ site_settings.site_name|default:"Safari & Bush Retreats" }}{% endblock %}</title>

    <!-- PREBOOT THEME (apply mapema bila FOUC) -->
    <script>
      (function(){
        try{
          var override = localStorage.getItem('theme_override'); // 'light'|'dark'|null
          var h = new Date().getHours();
          var auto = (h >= 18 || h < 6) ? 'dark' : 'light';
          var theme = override || auto;
          if(theme === 'dark'){ document.documentElement.classList.add('dark'); }
          else { document.documentElement.classList.remove('dark'); }
        }catch(e){}
      })();
    </script>
    
    <!-- Meta Tags -->
    <meta name="keywords" content="Tanzania, Safari, National Parks, Wildlife, Tours, Serengeti, Ngorongoro, Kilimanjaro">
    <meta name="description" content="{% block meta_description %}{{ site_settings.site_description|default:'Discover the beauty of Tanzania\'s national parks and wildlife with our expert-guided safari tours.' }}{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}Tanzania, Safari, National Parks, Wildlife, Tours, Serengeti, Ngorongoro, Kilimanjaro{% endblock %}">
    <meta name="author" content="{{ site_settings.site_name|default:"Safari & Bush Retreats" }}">

    <!-- Open Graph -->
    <meta property="og:title" content="{% block og_title %}{{ site_settings.site_name|default:"Safari & Bush Retreats" }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ site_settings.site_description|default:'Discover Tanzania\'s wildlife' }}{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">

    {% load static %}

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'images/favicon-96x96.png' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'images/favicon.svg' %}">
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/apple-touch-icon.png' %}">
    <meta name="apple-mobile-web-app-title" content="safari&bushretreats">
    <link rel="manifest" href="{% static 'images/site.webmanifest' %}">
    <!-- Preload logo for loader -->
    <link rel="preload" as="image" href="{% static 'images/favicon-96x96.png' %}">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

    <!-- Tailwind Configuration and Custom Styles -->
    <link href="{% static 'css/system.css'%}" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#C18D45',
                            dark: '#E4B366'
                        },
                        secondary: {
                            DEFAULT: '#715F3C',
                            dark: '#B8986F'
                        },
                        accent: {
                            DEFAULT: '#237D26',
                            dark: '#4CAF50'
                        }
                    },
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif']
                    },
                    transitionDuration: {
                        '300': '300ms'
                    }
                }
            }
        }
    </script>
    <style>
        /* ---------- Instagram-style global typography (font-size only) ---------- */
        :root{
            --fs-xxl: clamp(1.6rem, 4.0vw, 3.2rem);
            --fs-xl:  clamp(1.25rem, 2.6vw, 2.25rem);
            --fs-lg:  clamp(1.05rem, 1.9vw, 1.5rem);
            --fs-base:clamp(0.95rem, 1.0vw, 1.06rem);
            --fs-sm:  clamp(0.82rem, 0.8vw, 0.95rem);
            --fs-xs:  clamp(0.72rem, 0.7vw, 0.82rem);

            --lh-tight: 1.08;
            --lh-heading: 1.15;
            --lh-base: 1.42;
            --lh-small: 1.3;
        }

        html { font-size: 16px; }
        body { font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; font-size: var(--fs-base) !important; line-height: var(--lh-base) !important; }
        h1 { font-size: var(--fs-xxl) !important; line-height: var(--lh-tight) !important; font-weight: 600 !important; }
        h2 { font-size: var(--fs-xl) !important; line-height: var(--lh-heading) !important; font-weight: 600 !important; }
        h3 { font-size: var(--fs-lg) !important; line-height: var(--lh-heading) !important; font-weight: 600 !important; }
        h4 { font-size: calc(var(--fs-lg) - 0.06rem) !important; line-height: var(--lh-heading) !important; }
        h5 { font-size: var(--fs-sm) !important; line-height: var(--lh-small) !important; }
        h6 { font-size: var(--fs-sm) !important; line-height: var(--lh-small) !important; }
        p, .text-base, .prose, .article-body { font-size: var(--fs-base) !important; line-height: var(--lh-base) !important; }
        small, .text-muted, .text-gray-500, .meta { font-size: var(--fs-sm) !important; line-height: var(--lh-small) !important; }
        button, .btn, .inline-flex, input[type="email"], .dest-seemore { font-size: var(--fs-sm) !important; line-height: 1.2 !important; }
        .dest-title { font-size: var(--fs-sm) !important; line-height: 1.06 !important; font-weight: 500 !important; }
        .hero-content h1, .hero-main-title, .hero .text-5xl { font-size: clamp(1.25rem, 5.2vw, 2.8rem) !important; line-height: 1.02 !important; }

        @media (max-width: 420px){
            :root{
            --fs-xxl: clamp(1.25rem, 6.2vw, 1.8rem);
            --fs-xl:  clamp(1.0rem, 4.2vw, 1.25rem);
            --fs-lg:  clamp(0.95rem, 2.8vw, 1.125rem);
            --fs-base:clamp(0.88rem, 2.2vw, 0.98rem);
            --fs-sm:  clamp(0.68rem, 1.8vw, 0.82rem);
            --fs-xs:  clamp(0.62rem, 1.6vw, 0.72rem);
            }
            body, p, a, li { letter-spacing: -0.01em !important; }
        }
        a, button { text-rendering: optimizeLegibility; }
        .site-typography-overrides * { font-size: inherit !important; }

        /* ---------- Page Loader (logo + two-color ring) ---------- */
        :root{
            --brand-c1:#C18D45; /* primary */
            --brand-c2:#715F3C; /* secondary */
            --loader-bg-light:#ffffff;
            --loader-bg-dark:#111827;     /* gray-900 */
            --ring-track-light:#e5e7eb;   /* gray-200 */
            --ring-track-dark:#374151;    /* gray-700 */
        }

        .loader-overlay{
            position: fixed; inset: 0; z-index: 9999;
            display: grid; place-items: center;
            background: var(--loader-bg-light);
            transition: opacity .35s ease, visibility .35s ease;
        }
        @media (prefers-color-scheme: dark){
            .loader-overlay{ background: var(--loader-bg-dark); }
        }
        .dark .loader-overlay{ background: var(--loader-bg-dark); }

        .loader-overlay.loaded{ opacity: 0; visibility: hidden; }

        /* square wrapper to prevent “egg/horse-shoe” */
        .loader-wrap{
        position: relative;
        width: 104px;
        aspect-ratio: 1 / 1;      /* keeps the ring perfectly round */
        display: grid;
        place-items: center;      /* center things in the cell */
        }

        /* Duara nyembamba rangi mbili (nusu-nusu) */
        .loader-ring{
            --ring-w: 6px;
            width: 100%; height: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            position: relative;
            z-index: 1;
            background: conic-gradient(
                from 0deg,
                var(--brand-c1) 0 50%,
                var(--brand-c2) 50% 100%
            );
            -webkit-mask: radial-gradient(farthest-side,
                            transparent calc(100% - var(--ring-w)),
                            #000 calc(100% - var(--ring-w)));
                    mask: radial-gradient(farthest-side,
                            transparent calc(100% - var(--ring-w)),
                            #000 calc(100% - var(--ring-w)));
            animation: loader-spin 1s linear infinite;
            will-change: transform;
        }

        /* track laini nyuma ya ring (hufuata light/dark) */
        .loader-ring::before{
            content:none; position:absolute; inset:0; border-radius:inherit;
            background: var(--ring-track-light);
            -webkit-mask: radial-gradient(farthest-side,
                        transparent calc(100% - var(--ring-w)),
                        #000 calc(100% - var(--ring-w)));
                    mask: radial-gradient(farthest-side,
                        transparent calc(100% - var(--ring-w)),
                        #000 calc(100% - var(--ring-w)));
            z-index:-1;
        }
        .loader-ring,
            .loader-icon{
            grid-area: 1 / 1;
        }

        @media (prefers-color-scheme: dark){
            .loader-ring::before{ background: var(--ring-track-dark); }
        }
        .dark .loader-ring::before{ background: var(--ring-track-dark); }

        /* logo katikati */
        .loader-icon{
            width: 48px; height: 48px;
            object-fit: contain;
            z-index: 2;
            pointer-events: none;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,.15));
        }

        @keyframes loader-spin { to { transform: rotate(360deg); } }

        @media (prefers-reduced-motion: reduce){
            .loader-ring{ animation: none; }
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body class="font-poppins leading-relaxed text-gray-800 bg-white dark:text-gray-200 dark:bg-gray-900 transition-all duration-300 site-typography-overrides">
    <!-- Page Loader -->
    <div id="page-loader" class="loader-overlay" role="status" aria-live="polite" aria-busy="true">
    <div class="loader-wrap">
        <div class="loader-ring" aria-hidden="true"></div>
        <img class="loader-icon" src="{% static 'images/favicon-96x96.png' %}" alt="{{ site_settings.site_name|default:'Logo' }}">
    </div>
    <span class="sr-only">Loading…</span>
    </div>

    <!-- Header with two rows -->
    <header class="header sticky top-0 z-50 transition-all duration-300">
        <!-- Primary Row: Logo, Brand, Links -->
        <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 primary-row">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between h-12 md:h-16">
                    <a class="flex items-center md:text-xl font-bold text-primary dark:text-primary-dark hover:text-secondary dark:hover:text-secondary-dark transition-colors duration-300"
                        href="{% url 'core:home' %}">
                        <img src="{% static 'images/online.png' %}"
                            alt="{{ site_settings.site_name|default:'Logo' }}"
                            class="h-10 md:h-12 w-auto mr-2 block dark:hidden object-contain" />

                        <img src="{% static 'images/online.png' %}"
                            alt=" "
                            class="h-10 md:h-12 w-auto mr-2 hidden dark:block object-contain" />

                        <span>{{ site_settings.site_name|default:"Safari & Bush Retreats" }}</span>
                    </a>
                    
                    <!-- Mobile menu button -->
                    <button class="lg:hidden p-2 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark transition-colors duration-300" type="button" id="mobile-menu-toggle" aria-label="Toggle navigation">
                        <span class="block w-6 h-0.5 bg-gray-600 dark:bg-gray-300 mb-1 transition-all duration-300"></span>
                        <span class="block w-6 h-0.5 bg-gray-600 dark:bg-gray-300 mb-1 transition-all duration-300"></span>
                        <span class="block w-6 h-0.5 bg-gray-600 dark:bg-gray-300 transition-all duration-300"></span>
                    </button>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex items-center space-x-8">
                        <ul class="flex items-center space-x-6">
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'core:home' %}">Home</a>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'park_list' %}active{% endif %}" href="{% url 'parks:park_list' %}">National Parks</a>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'tour_list' %}active{% endif %}" href="{% url 'tours:tour_list' %}">Safari Tours</a>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'review_list' %}active{% endif %}" href="{% url 'reviews:review_list' %}">Reviews</a>
                            </li>
                            <li class="relative group">
                                <button class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 flex items-center {% if 'destination' in request.resolver_match.url_name or 'wildlife' in request.resolver_match.url_name or 'historical_sites' in request.resolver_match.url_name or 'guide' in request.resolver_match.url_name %}active{% endif %}" id="destinationsDropdown" aria-expanded="false">
                                    Destinations
                                    <i class="fas fa-chevron-down ml-1 text-xs group-hover:rotate-180 transition-transform duration-300"></i>
                                </button>
                                <div class="absolute top-full left-0 mt-2 w-80 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50">
                                    <div class="p-2">
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}">
                                            <i class="fas fa-map-marker-alt mr-3 w-4"></i>All Destinations
                                        </a>
                                        <hr class="my-2 border-gray-200 dark:border-gray-600">
                                        <h6 class="px-4 py-2 text-primary dark:text-primary-dark font-semibold text-sm">By Category</h6>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=wildlife_area">
                                            <i class="fas fa-paw mr-3 w-4"></i>Wildlife Areas
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=viewpoint">
                                            <i class="fas fa-mountain mr-3 w-4"></i>Viewpoints
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=waterfall">
                                            <i class="fas fa-tint mr-3 w-4"></i>Waterfalls
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=lake">
                                            <i class="fas fa-water mr-3 w-4"></i>Lakes
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=beach">
                                            <i class="fas fa-umbrella-beach mr-3 w-4"></i>Beaches
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=cultural_site">
                                            <i class="fas fa-users mr-3 w-4"></i>Cultural Sites
                                        </a>
                                        <hr class="my-2 border-gray-200 dark:border-gray-600">
                                        <h6 class="px-4 py-2 text-primary dark:text-primary-dark font-semibold text-sm">Special Collections</h6>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:wildlife_list' %}">
                                            <i class="fas fa-binoculars mr-3 w-4"></i>Wildlife Species
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:wildlife_list' %}?big_five=true">
                                            <i class="fas fa-crown mr-3 w-4"></i>Big Five
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'core:historical_sites_list' %}">
                                            <i class="fas fa-landmark mr-3 w-4"></i>Historical Sites
                                        </a>
                                        {% comment %} <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'tours:guide_list' %}">
                                            <i class="fas fa-user-tie mr-3 w-4"></i>Tour Guides
                                        </a> {% endcomment %}
                                    </div>
                                </div>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'about' %}active{% endif %}" href="{% url 'core:about' %}">About</a>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'contact' %}active{% endif %}" href="{% url 'core:contact' %}">Contact</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Mobile Navigation Menu -->
                <div class="lg:hidden mobile-menu hidden bg-white dark:bg-gray-700 rounded-lg mt-4 p-4 shadow-2xl border border-gray-200 dark:border-gray-600 fixed left-4 right-4 top-8" id="mobile-menu">
                    <ul class="space-y-2">
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'core:home' %}">Home</a></li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'park_list' %}active{% endif %}" href="{% url 'parks:park_list' %}">National Parks</a></li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'tour_list' %}active{% endif %}" href="{% url 'tours:tour_list' %}">Safari Tours</a></li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'review_list' %}active{% endif %}" href="{% url 'reviews:review_list' %}">Reviews</a></li>
                        <!-- Mobile Destinations Dropdown -->
                        <li class="mobile-dropdown-container">
                            <button class="mobile-dropdown-toggle w-full flex items-center justify-between px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if 'destination' in request.resolver_match.url_name or 'wildlife' in request.resolver_match.url_name or 'historical_sites' in request.resolver_match.url_name or 'guide' in request.resolver_match.url_name %}active{% endif %}" 
                                    id="mobile-destinations-toggle" 
                                    aria-expanded="false" 
                                    aria-controls="mobile-destinations-menu">
                                <span class="font-medium">Destinations</span>
                                <i class="fas fa-chevron-down mobile-dropdown-icon transition-transform duration-300 text-sm"></i>
                            </button>
                            
                            <div class="mobile-dropdown-menu hidden mt-2 ml-4 space-y-1 overflow-hidden transition-all duration-300" id="mobile-destinations-menu">
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.resolver_match.url_name == 'destination_list' and not request.GET.type %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}">
                                    <i class="fas fa-map-marker-alt mr-3 w-4 text-center"></i>
                                    <span>All Destinations</span>
                                    {% if request.resolver_match.url_name == 'destination_list' and not request.GET.type %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <div class="px-4 py-2">
                                    <hr class="border-gray-300 dark:border-gray-600">
                                    <h6 class="text-primary dark:text-primary-dark font-semibold text-sm mt-2 mb-1">By Category</h6>
                                </div>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'wildlife_area' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=wildlife_area">
                                    <i class="fas fa-paw mr-3 w-4 text-center"></i>
                                    <span>Wildlife Areas</span>
                                    {% if request.GET.type == 'wildlife_area' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'viewpoint' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=viewpoint">
                                    <i class="fas fa-mountain mr-3 w-4 text-center"></i>
                                    <span>Viewpoints</span>
                                    {% if request.GET.type == 'viewpoint' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'waterfall' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=waterfall">
                                    <i class="fas fa-tint mr-3 w-4 text-center"></i>
                                    <span>Waterfalls</span>
                                    {% if request.GET.type == 'waterfall' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'lake' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=lake">
                                    <i class="fas fa-water mr-3 w-4 text-center"></i>
                                    <span>Lakes</span>
                                    {% if request.GET.type == 'lake' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'beach' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=beach">
                                    <i class="fas fa-umbrella-beach mr-3 w-4 text-center"></i>
                                    <span>Beaches</span>
                                    {% if request.GET.type == 'beach' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'cultural_site' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=cultural_site">
                                    <i class="fas fa-users mr-3 w-4 text-center"></i>
                                    <span>Cultural Sites</span>
                                    {% if request.GET.type == 'cultural_site' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <div class="px-4 py-2">
                                    <hr class="border-gray-300 dark:border-gray-600">
                                    <h6 class="text-primary dark:text-primary-dark font-semibold text-sm mt-2 mb-1">Special Collections</h6>
                                </div>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.resolver_match.url_name == 'wildlife_list' and not request.GET.big_five %}active{% endif %}" 
                                   href="{% url 'parks:wildlife_list' %}">
                                    <i class="fas fa-binoculars mr-3 w-4 text-center"></i>
                                    <span>Wildlife Species</span>
                                    {% if request.resolver_match.url_name == 'wildlife_list' and not request.GET.big_five %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.big_five == 'true' %}active{% endif %}" 
                                   href="{% url 'parks:wildlife_list' %}?big_five=true">
                                    <i class="fas fa-crown mr-3 w-4 text-center"></i>
                                    <span>Big Five</span>
                                    {% if request.GET.big_five == 'true' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.resolver_match.url_name == 'historical_sites_list' %}active{% endif %}" 
                                   href="{% url 'core:historical_sites_list' %}">
                                    <i class="fas fa-landmark mr-3 w-4 text-center"></i>
                                    <span>Historical Sites</span>
                                    {% if request.resolver_match.url_name == 'historical_sites_list' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                            </div>
                        </li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'about' %}active{% endif %}" href="{% url 'core:about' %}">About</a></li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'contact' %}active{% endif %}" href="{% url 'core:contact' %}">Contact</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Secondary Row: Search, User Menu, Dark/Light Mode -->
        <nav class="bg-white dark:bg-gray-800 secondary-row py-1">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center w-full flex-col md:flex-row gap-4 md:gap-0">
                    <!-- Search Form -->
                    <form class="flex flex-1 md:max-w-lg max-w-full min-w-0 w-full md:w-auto" method="GET" action="{% url 'core:search' %}">
                        <div class="flex w-full min-w-0">
                            <input
                                class="flex-1 min-w-0 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-l-lg text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark focus:border-transparent transition-all duration-300"
                                type="search" name="q" placeholder="Search tours, parks..." value="{{ request.GET.q }}" aria-label="Search">
                            <button
                                class="px-4 py-2 bg-primary dark:bg-primary-dark text-white border border-primary dark:border-primary-dark rounded-r-lg hover:bg-secondary dark:hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark transition-all duration-300 hover:-translate-y-0.5 flex-shrink-0"
                                type="submit" aria-label="Search button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>

                    <!-- User Menu and Theme Toggle -->
                    <ul class="flex items-center space-x-4 w-full md:w-auto justify-center md:justify-end min-w-0">
                        {% if user.is_authenticated %}
                            <li class="relative group">
                                <button class="flex items-center text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-colors duration-300 focus-primary" id="userDropdown" aria-expanded="false">
                                    <i class="fas fa-user mr-2"></i>
                                    <span class="md:inline hidden truncate">{{ user.get_display_name }}</span>
                                    <i class="fas fa-chevron-down ml-1 text-xs group-hover:rotate-180 transition-transform duration-300"></i>
                                </button>
                                <div class="absolute top-full right-0 mt-2 w-48 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50">
                                    <div class="p-2">
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'accounts:dashboard' %}">
                                            <i class="fas fa-tachometer-alt mr-3 w-4"></i>Dashboard
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'bookings:booking_list' %}">
                                            <i class="fas fa-calendar-check mr-3 w-4"></i>My Bookings
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'accounts:profile_update' %}">
                                            <i class="fas fa-user-edit mr-3 w-4"></i>Profile
                                        </a>
                                        <hr class="my-2 border-gray-200 dark:border-gray-600">
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'accounts:logout' %}">
                                            <i class="fas fa-sign-out-alt mr-3 w-4"></i>Logout
                                        </a>
                                    </div>
                                </div>
                            </li>
                        {% else %}
                            <li>
                                <a class="text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-colors duration-300 focus-primary" href="{% url 'accounts:login' %}">
                                    <i class="fas fa-sign-in-alt mr-1 md:hidden"></i>
                                    <span class="md:inline">Login</span>
                                </a>
                            </li>
                            <li>
                                <a class="inline-flex items-center px-4 py-2 bg-primary dark:bg-primary-dark text-white rounded-lg hover:bg-secondary dark:hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark transition-all duration-300 hover:-translate-y-0.5 text-sm font-medium" href="{% url 'accounts:register' %}">
                                    <i class="fas fa-user-plus mr-1 md:hidden"></i>
                                    <span class="md:inline">Sign Up</span>
                                </a>
                            </li>
                        {% endif %}

                        <!-- Dark/Light Mode Toggle -->
                        <li>
                            <button id="theme-toggle" class="w-10 h-10 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-600 rounded-lg hover:text-primary hover:bg-primary hover:text-white dark:hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md flex items-center justify-center" title="Toggle Theme" aria-label="Toggle dark/light mode">
                                <i class="fas fa-moon text-lg" id="theme-icon"></i>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Messages -->
    {% if messages %}
        <div class="container mx-auto px-4 mt-2">
            {% for message in messages %}
                <div class="alert-enter flex items-center p-4 mb-4 rounded-lg border-l-4 {% if message.tags == 'success' %}bg-green-50 dark:bg-green-900/20 border-green-500 text-green-700 dark:text-green-400{% elif message.tags == 'error' or message.tags == 'danger' %}bg-red-50 dark:bg-red-900/20 border-red-500 text-red-700 dark:text-red-400{% elif message.tags == 'warning' %}bg-yellow-50 dark:bg-yellow-900/20 border-yellow-500 text-yellow-700 dark:text-yellow-400{% else %}bg-blue-50 dark:bg-blue-900/20 border-blue-500 text-blue-700 dark:text-blue-400{% endif %} transition-all duration-300" role="alert">
                    <i class="fas fa-info-circle mr-3"></i>
                    <span class="flex-1">{{ message }}</span>
                    <button type="button" class="ml-4 text-current hover:text-opacity-75 focus:outline-none focus:text-opacity-75 transition-colors duration-300" onclick="this.parentElement.remove()" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <main>
        {% block content %}
        
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-50 border-t border-white">
        <div class="container mx-auto max-w-7xl px-4 py-12">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-8">
            <!-- Brand / Description -->
            <div class="md:col-span-2">
                <h5 class="text-xl font-semibold text-[#C18D45] mb-3">{{ site_settings.site_name|default:"Safari & Bush Retreats" }}</h5>
                <p class="mb-4 text-sm text-gray-200">
                Experience the magic of Tanzania's wildlife and landscapes with our expert-guided safari tours. From the Serengeti to Kilimanjaro, we make your African dreams come true.
                </p>

                <div class="flex items-center space-x-4">
                {% if site_settings.facebook_url %}
                    <a href="{{ site_settings.facebook_url }}" class="text-gray-400 hover:text-[#C18D45] transition">
                    <i class="fab fa-facebook-f" aria-hidden="true"></i>
                    <span class="sr-only">Facebook</span>
                    </a>
                {% endif %}
                {% if site_settings.twitter_url %}
                    <a href="{{ site_settings.twitter_url }}" class="text-gray-400 hover:text-[#C18D45] transition">
                    <i class="fa-brands fa-x-twitter"></i>
                    <span class="sr-only">Twitter</span>
                    </a>
                {% endif %}
                {% if site_settings.instagram_url %}
                    <a href="{{ site_settings.instagram_url }}" class="text-gray-400 hover:text-[#C18D45] transition">
                    <i class="fab fa-instagram" aria-hidden="true"></i>
                    <span class="sr-only">Instagram</span>
                    </a>
                {% endif %}
                {% if site_settings.youtube_url %}
                    <a href="{{ site_settings.youtube_url }}" class="text-gray-400 hover:text-[#C18D45] transition">
                    <i class="fab fa-youtube" aria-hidden="true"></i>
                    <span class="sr-only">YouTube</span>
                    </a>
                {% endif %}
                </div>
            </div>

            <!-- Quick Links -->
            <div>
                <h6 class="text-sm font-semibold text-[#C18D45] mb-3">Quick Links</h6>
                <ul class="space-y-2 text-sm">
                <li><a href="{% url 'core:home' %}" class="hover:text-[#C18D45] transition">Home</a></li>
                <li><a href="{% url 'parks:park_list' %}" class="hover:text-[#C18D45] transition">National Parks</a></li>
                <li><a href="{% url 'tours:tour_list' %}" class="hover:text-[#C18D45] transition">Safari Tours</a></li>
                <li><a href="{% url 'core:about' %}" class="hover:text-[#C18D45] transition">About Us</a></li>
                <li><a href="{% url 'core:contact' %}" class="hover:text-[#C18D45] transition">Contact</a></li>
                </ul>
            </div>

            <!-- Destinations -->
            <div>
                <h6 class="text-sm font-semibold text-[#C18D45] mb-3">Destinations</h6>
                <ul class="space-y-2 text-sm">
                <li><a href="{% url 'parks:destination_list' %}" class="hover:text-[#C18D45] transition">All Destinations</a></li>
                <li><a href="{% url 'parks:wildlife_list' %}" class="hover:text-[#C18D45] transition">Wildlife</a></li>
                <li><a href="{% url 'core:historical_sites_list' %}" class="hover:text-[#C18D45] transition">Historical Sites</a></li>
                <li><a href="{% url 'parks:park_list' %}" class="hover:text-[#C18D45] transition">National Parks</a></li>
                </ul>
            </div>

            <!-- Support -->
            <div>
                <h6 class="text-sm font-semibold text-[#C18D45] mb-3">Support</h6>
                <ul class="space-y-2 text-sm">
                <li><a href="{% url 'core:faq' %}" class="hover:text-[#C18D45] transition">FAQ</a></li>
                <li><a href="{% url 'core:privacy_policy' %}" class="hover:text-[#C18D45] transition">Privacy Policy</a></li>
                <li><a href="{% url 'core:terms_of_service' %}" class="hover:text-[#C18D45] transition">Terms of Service</a></li>
                <li><a href="#" class="hover:text-[#C18D45] transition">Travel Insurance</a></li>
                <li><a href="#" class="hover:text-[#C18D45] transition">Visa Information</a></li>
                </ul>
            </div>

            <!-- Contact Info -->
            <div>
                <h6 class="text-sm font-semibold text-[#C18D45] mb-3">Contact Info</h6>
                <ul class="space-y-2 text-sm text-gray-400">
                    <li class="flex items-start">
                        <i class="fas fa-phone mr-2 mt-0.5" aria-hidden="true"></i>
                        <span>{{ site_settings.contact_phone|default:"+255 768 373 033" }}</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-envelope mr-2 mt-0.5" aria-hidden="true"></i>
                        <span>{{ site_settings.contact_email|default:"safariandbushretreats@gmail.com" }}</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-map-marker-alt mr-2 mt-0.5" aria-hidden="true"></i>
                        <span>{{ site_settings.address|default:"Iringa, Tanzania" }}</span>
                    </li>
                </ul>
            </div>
            </div>

            <div class="border-t border-gray-200 mt-8 pt-6">
                <div class="flex flex-col md:flex-row items-center justify-between gap-3 text-sm text-gray-500">
                    <p class="mb-0">&copy; 2024 {{ site_settings.site_name|default:"Safari & Bush Retreats" }}. All rights reserved.</p>
                    <p class="mb-0">
                        Developed by
                        <a href="https://www.instagram.com/nexivo.io/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center ml-1 text-primary hover:underline" aria-label="nexivo on Instagram">
                            Nexivo
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- ENHANCED JavaScript with all fixes -->
    <script>
        // ---------- THEME MANAGER (Auto day/night + manual override) ----------
        class ThemeManager {
            constructor({ dayStart = 6, nightStart = 18 } = {}) {
                this.themeToggle = document.getElementById('theme-toggle');
                this.themeIcon   = document.getElementById('theme-icon');

                this.dayStart = dayStart;
                this.nightStart = nightStart;
                this.currentTheme = 'light';
                this.autoTimer = null;

                const legacy = localStorage.getItem('theme');
                if (legacy && !localStorage.getItem('theme_override')) {
                    localStorage.setItem('theme_override', legacy);
                    localStorage.removeItem('theme');
                }

                this.init();
            }

            init() {
                this.refreshTheme();
                if (this.themeToggle) {
                    this.themeToggle.addEventListener('click', (e) => {
                        if (e.shiftKey) {
                            this.clearUserOverride();
                            this.refreshTheme();
                            this.pulseButton();
                            return;
                        }
                        this.toggleTheme();
                    });
                    this.themeToggle.title = 'Click: Light/Dark • Shift+Click: Auto';
                }
                this.scheduleNextAutoCheck();
            }

            getUserOverride() { return localStorage.getItem('theme_override'); }
            setUserOverride(theme) { localStorage.setItem('theme_override', theme); }
            clearUserOverride() { localStorage.removeItem('theme_override'); }

            computeAutoTheme(now = new Date()) {
                const h = now.getHours();
                const isNight = (h >= this.nightStart) || (h < this.dayStart);
                return isNight ? 'dark' : 'light';
            }

            applyTheme(theme) {
                this.currentTheme = theme;
                if (theme === 'dark') { document.documentElement.classList.add('dark'); }
                else { document.documentElement.classList.remove('dark'); }
                this.updateThemeIcon();
            }

            refreshTheme() {
                const override = this.getUserOverride();
                const themeToApply = override || this.computeAutoTheme();
                this.applyTheme(themeToApply);
                this.scheduleNextAutoCheck();
            }

            toggleTheme() {
                const next = this.currentTheme === 'light' ? 'dark' : 'light';
                this.applyTheme(next);
                this.setUserOverride(next);
                this.pulseButton();
            }

            updateThemeIcon() {
                const isDark = this.currentTheme === 'dark';
                const icon = isDark ? 'fa-sun' : 'fa-moon';
                if (this.themeIcon) {
                    this.themeIcon.className = `fas ${icon} text-lg`;
                }
                if (this.themeToggle) {
                    const mode = this.getUserOverride() ? 'Manual' : 'Auto';
                    this.themeToggle.title = `${mode}: ${this.currentTheme.toUpperCase()} • Click: Light/Dark • Shift+Click: Auto`;
                }
            }

            pulseButton() {
                if (!this.themeToggle) return;
                this.themeToggle.style.transform = 'scale(0.9)';
                setTimeout(() => { this.themeToggle.style.transform = 'scale(1)'; }, 150);
            }

            scheduleNextAutoCheck() {
                if (this.getUserOverride()) {
                    if (this.autoTimer) clearTimeout(this.autoTimer);
                    this.autoTimer = null;
                    return;
                }

                const now = new Date();
                const h = now.getHours();
                let next = new Date(now);
                if (h >= this.nightStart || h < this.dayStart) {
                    next.setHours(this.dayStart, 0, 0, 0);
                    if (now >= next) next.setDate(next.getDate() + 1);
                } else {
                    next.setHours(this.nightStart, 0, 0, 0);
                    if (now >= next) next.setDate(next.getDate() + 1);
                }

                const ms = next - now;
                if (this.autoTimer) clearTimeout(this.autoTimer);
                this.autoTimer = setTimeout(() => { this.refreshTheme(); }, ms);
            }
        }
        // ---------- /THEME MANAGER ----------

        // Header Scroll Behavior
        class HeaderManager {
            constructor({ scrollThreshold = 150, delta = 10 } = {}) {
                this.header = document.querySelector('.header');
                if (!this.header) return;
                this.scrollThreshold = scrollThreshold;
                this.delta = delta;
                this.lastScrollTop = window.pageYOffset || document.documentElement.scrollTop || 0;
                this.latestScroll = this.lastScrollTop;
                this.ticking = false;
                this.init();
            }
            init() {
                window.addEventListener('scroll', () => this.onScroll(), { passive: true });
                window.addEventListener('mousemove', (e) => { if (e.clientY < 80) this.showHeader(); }, { passive: true });
                window.addEventListener('keydown', (e) => { if (['ArrowUp','PageUp','Home'].includes(e.key)) this.showHeader(); });
            }
            onScroll() {
                this.latestScroll = window.pageYOffset || document.documentElement.scrollTop || 0;
                if (!this.ticking) { this.ticking = true; requestAnimationFrame(() => this.handleScroll()); }
            }
            handleScroll() {
                const scrollTop = this.latestScroll;
                if (Math.abs(scrollTop - this.lastScrollTop) <= this.delta) { this.ticking = false; return; }
                const isDown = scrollTop > this.lastScrollTop;
                if (isDown && scrollTop > this.scrollThreshold) { this.header.classList.add('header-scrolled'); }
                else { this.header.classList.remove('header-scrolled'); }
                this.lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
                this.ticking = false;
            }
            showHeader() {
                if (this.header && this.header.classList.contains('header-scrolled')) {
                    this.header.classList.remove('header-scrolled');
                    this.lastScrollTop = window.pageYOffset || document.documentElement.scrollTop || 0;
                }
            }
        }

        // Mobile Menu Manager
        class MobileMenuManager {
            constructor() {
                this.menuToggle = document.getElementById('mobile-menu-toggle');
                this.mobileMenu = document.getElementById('mobile-menu');
                this.destinationsToggle = document.getElementById('mobile-destinations-toggle');
                this.destinationsMenu = document.getElementById('mobile-destinations-menu');
                this.isOpen = false;
                this.isDestinationsOpen = false;
                this.init();
            }
            init() {
                this.menuToggle.addEventListener('click', () => this.toggleMenu());
                if (this.destinationsToggle && this.destinationsMenu) {
                    this.destinationsToggle.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); this.toggleDestinations(); });
                }
                document.addEventListener('click', (e) => {
                    if (this.isOpen && !this.menuToggle.contains(e.target) && !this.mobileMenu.contains(e.target)) { this.closeMenu(); }
                });
                this.setupTouchEvents();
            }
            toggleMenu() { this.isOpen ? this.closeMenu() : this.openMenu(); }
            openMenu() {
                this.mobileMenu.classList.remove('hidden');
                this.isOpen = true;
                this.animateToggler(true);
            }
            closeMenu() {
                this.mobileMenu.classList.add('hidden');
                this.isOpen = false;
                this.animateToggler(false);
                if (this.isDestinationsOpen) { this.closeDestinations(); }
            }
            animateToggler(isOpen) {
                const spans = this.menuToggle.querySelectorAll('span');
                if (isOpen) {
                    spans[0].style.transformOrigin = "center";
                    spans[2].style.transformOrigin = "center";
                    spans[0].style.transform = 'translateY(6px) rotate(45deg)';
                    spans[1].style.opacity = '0';
                    spans[2].style.transform = 'translateY(-6px) rotate(-45deg)';
                } else {
                    spans[0].style.transform = 'translateY(0) rotate(0)';
                    spans[1].style.opacity = '1';
                    spans[2].style.transform = 'translateY(0) rotate(0)';
                }
            }
            toggleDestinations() { this.isDestinationsOpen ? this.closeDestinations() : this.openDestinations(); }
            openDestinations() {
                this.destinationsMenu.classList.remove('hidden');
                this.destinationsMenu.classList.add('show');
                this.destinationsToggle.setAttribute('aria-expanded', 'true');
                this.isDestinationsOpen = true;
                if (navigator.vibrate) { navigator.vibrate(10); }
            }
            closeDestinations() {
                this.destinationsMenu.classList.remove('show');
                this.destinationsToggle.setAttribute('aria-expanded', 'false');
                this.isDestinationsOpen = false;
                setTimeout(() => { if (!this.isDestinationsOpen) this.destinationsMenu.classList.add('hidden'); }, 400);
            }
            setupTouchEvents() {
                const dropdownItems = document.querySelectorAll('.mobile-dropdown-item');
                dropdownItems.forEach(item => {
                    let touchStartTime, touchStartY;
                    item.addEventListener('touchstart', (e) => {
                        touchStartTime = Date.now();
                        touchStartY = e.touches[0].clientY;
                        item.style.backgroundColor = 'rgba(193, 141, 69, 0.1)';
                    }, { passive: true });
                    item.addEventListener('touchend', (e) => {
                        const touchDuration = Date.now() - touchStartTime;
                        const touchEndY = e.changedTouches[0].clientY;
                        const touchDistance = Math.abs(touchEndY - touchStartY);
                        setTimeout(() => { item.style.backgroundColor = ''; }, 150);
                        if (touchDuration < 300 && touchDistance < 10) {
                            const href = item.getAttribute('href');
                            if (href && href !== '#') { setTimeout(() => { window.location.href = href; }, 100); }
                        }
                    }, { passive: true });
                    item.addEventListener('touchcancel', () => { item.style.backgroundColor = ''; }, { passive: true });
                });
                if (this.destinationsToggle) {
                    this.destinationsToggle.addEventListener('touchstart', () => {
                        this.destinationsToggle.style.backgroundColor = 'rgba(193, 141, 69, 0.1)';
                    }, { passive: true });
                    this.destinationsToggle.addEventListener('touchend', () => {
                        setTimeout(() => { this.destinationsToggle.style.backgroundColor = ''; }, 150);
                    }, { passive: true });
                }
            }
        }

        // Alert Management
        class AlertManager {
            constructor() { this.init(); }
            init() { this.autoHideAlerts(); }
            autoHideAlerts() {
                setTimeout(() => {
                    const alerts = document.querySelectorAll('.alert-enter:not(.alert-permanent)');
                    alerts.forEach(alert => {
                        alert.classList.add('alert-exit');
                        setTimeout(() => alert.remove(), 300);
                    });
                }, 5000);
            }
        }

        // Search Enhancement
        class SearchManager {
            constructor() { this.searchInput = document.querySelector('input[name="q"]'); this.init(); }
            init() {
                if (this.searchInput) {
                    this.searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') { this.searchInput.closest('form').submit(); }
                    });
                }
            }
        }

        // Initialize managers when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            try {
                new ThemeManager();
                new HeaderManager();
                new MobileMenuManager();
                new AlertManager();
                new SearchManager();

                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        e.preventDefault();
                        const target = document.querySelector(this.getAttribute('href'));
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                });
            } catch (error) { console.error('Error initializing page components:', error); }
        });

        // Newsletter
        function subscribeNewsletter() {
            const emailInput = document.getElementById('newsletter-email');
            if (!emailInput) { console.error('Newsletter email input not found'); return; }
            const email = emailInput.value.trim();
            if (!email) { alert('Please enter your email address'); return; }
            if (!email.includes('@')) { alert('Please enter a valid email address'); return; }
            fetch('{% url "core:newsletter_signup" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}' },
                body: 'email=' + encodeURIComponent(email)
            })
            .then(r => r.json())
            .then(data => { alert(data.message); if (data.success) emailInput.value = ''; })
            .catch(err => { console.error('Error:', err); alert('An error occurred. Please try again.'); });
        }
        
        // ---------- PAGE LOADER (hide early like Google) ----------
        (function(){
          const overlay = document.getElementById('page-loader');
          if(!overlay) return;

          const start = performance.now();
          const MIN_MS = 120;   // kuepuka flicker
          const KILL_MS = 8000; // fallback usalama

          function reallyHide(){
            if(!overlay || overlay.classList.contains('loaded')) return;
            overlay.classList.add('loaded');
            setTimeout(()=> overlay.remove(), 300);
          }

          function hide(){
            const elapsed = performance.now() - start;
            const delay = Math.max(0, MIN_MS - elapsed);
            setTimeout(reallyHide, delay);
          }

          // Hide mapema mara DOM ikiwekwa tayari
          if (document.readyState === 'interactive' || document.readyState === 'complete') {
            hide();
          } else {
            document.addEventListener('DOMContentLoaded', hide, { once: true });
          }

          // Backup on window load
          window.addEventListener('load', hide, { once: true });

          // Safety kill
          setTimeout(reallyHide, KILL_MS);
        })();
        
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
