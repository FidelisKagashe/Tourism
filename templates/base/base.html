<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ site_settings.site_name|default:"Safari & Bush Retreats" }}{% endblock %}</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="{% block meta_description %}{{ site_settings.site_description|default:'Discover the beauty of Tanzania\'s national parks and wildlife with our expert-guided safari tours.' }}{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}Tanzania, Safari, National Parks, Wildlife, Tours, Serengeti, Ngorongoro, Kilimanjaro{% endblock %}">
    <meta name="author" content="{{ site_settings.site_name|default:"Safari & Bush Retreats" }}">
    
    <!-- Open Graph -->
    <meta property="og:title" content="{% block og_title %}{{ site_settings.site_name|default:"Safari & Bush Retreats" }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ site_settings.site_description|default:'Discover Tanzania\'s wildlife' }}{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    {% load static %}
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

    <!-- Tailwind Configuration and Custom Styles -->
    <link href="{% static 'css/system.css'%}" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#C18D45',
                            dark: '#E4B366'
                        },
                        secondary: {
                            DEFAULT: '#715F3C',
                            dark: '#B8986F'
                        },
                        accent: {
                            DEFAULT: '#237D26',
                            dark: '#4CAF50'
                        }
                    },
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif']
                    },
                    transitionDuration: {
                        '300': '300ms'
                    }
                }
            }
        }
    </script>
    <style>
        /* ---------- Instagram-style global typography (font-size only) ----------
           Goal: override Tailwind utility sizes and provide a compact, polished
           typographic scale similar to Instagram's look on desktop & mobile.
           This file only changes font sizes and line-heights — no layout changes.
        */

        :root{
            /* responsive typographic scale using CSS variables */
            --fs-xxl: clamp(1.6rem, 4.0vw, 3.2rem);  /* very large headings (hero) */
            --fs-xl:  clamp(1.25rem, 2.6vw, 2.25rem); /* large headings */
            --fs-lg:  clamp(1.05rem, 1.9vw, 1.5rem);  /* section headings */
            --fs-base:clamp(0.95rem, 1.0vw, 1.06rem);/* body / paragraphs */
            --fs-sm:  clamp(0.82rem, 0.8vw, 0.95rem); /* small buttons / labels */
            --fs-xs:  clamp(0.72rem, 0.7vw, 0.82rem); /* fine print */

            /* line-height presets tuned for a tight, modern feel */
            --lh-tight: 1.08;
            --lh-heading: 1.15;
            --lh-base: 1.42;
            --lh-small: 1.3;
        }

        /* base */
        html { font-size: 16px; }
        body { font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; font-size: var(--fs-base) !important; line-height: var(--lh-base) !important; }

        /* headings — tight and compact like IG */
        h1 { font-size: var(--fs-xxl) !important; line-height: var(--lh-tight) !important; font-weight: 600 !important; }
        h2 { font-size: var(--fs-xl) !important; line-height: var(--lh-heading) !important; font-weight: 600 !important; }
        h3 { font-size: var(--fs-lg) !important; line-height: var(--lh-heading) !important; font-weight: 600 !important; }
        h4 { font-size: calc(var(--fs-lg) - 0.06rem) !important; line-height: var(--lh-heading) !important; }
        h5 { font-size: var(--fs-sm) !important; line-height: var(--lh-small) !important; }
        h6 { font-size: var(--fs-sm) !important; line-height: var(--lh-small) !important; }

        /* paragraphs and common text utilities */
        p, .text-base, .prose, .article-body { font-size: var(--fs-base) !important; line-height: var(--lh-base) !important; }

        /* small text and muted labels */
        small, .text-muted, .text-gray-500, .meta { font-size: var(--fs-sm) !important; line-height: var(--lh-small) !important; }

        /* buttons, pills, inputs — slightly smaller for compact look */
        button, .btn, .inline-flex, input[type="email"], .dest-seemore { font-size: var(--fs-sm) !important; line-height: 1.2 !important; }

        /* destination card title (compact, readable) */
        .dest-title { font-size: var(--fs-sm) !important; line-height: 1.06 !important; font-weight: 500 !important; }

        /* hero special sizing (keeps hero large but not oversized on phones) */
        .hero-content h1, .hero-main-title, .hero .text-5xl { font-size: clamp(1.25rem, 5.2vw, 2.8rem) !important; line-height: 1.02 !important; }

        /* mobile tweaks: make very small screens a bit tighter */
        @media (max-width: 420px){
            :root{
                --fs-xxl: clamp(1.25rem, 6.2vw, 1.8rem);
                --fs-xl:  clamp(1.0rem, 4.2vw, 1.25rem);
                --fs-lg:  clamp(0.95rem, 2.8vw, 1.125rem);
                --fs-base:clamp(0.88rem, 2.2vw, 0.98rem);
                --fs-sm:  clamp(0.68rem, 1.8vw, 0.82rem);
                --fs-xs:  clamp(0.62rem, 1.6vw, 0.72rem);
            }

            /* reduce letter-spacing slightly for compactness on phones */
            body, p, a, li { letter-spacing: -0.01em !important; }
        }

        /* accessibility: ensure contrast isn't affected by font-size overrides */
        a, button { text-rendering: optimizeLegibility; }

        /* small helper to override utilities that may be more specific */
        .site-typography-overrides * { font-size: inherit !important; }

        /* End of font-only adjustments */
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body class="font-poppins leading-relaxed text-gray-800 bg-white dark:text-gray-200 dark:bg-gray-900 transition-all duration-300 site-typography-overrides">
    <!-- Header with two rows -->
    <header class="header sticky top-0 z-50 transition-all duration-300">
        <!-- Primary Row: Logo, Brand, Links -->
        <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 primary-row">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between h-12 md:h-16">
                    <a class="flex items-center md:text-xl font-bold text-primary dark:text-primary-dark hover:text-secondary dark:hover:text-secondary-dark transition-colors duration-300"
                        href="{% url 'core:home' %}">
                        <img src="{% static 'images/online.png' %}"
                            alt="{{ site_settings.site_name|default:'Logo' }}"
                            class="h-10 md:h-12 w-auto mr-2 block dark:hidden object-contain" />

                        <img src="{% static 'images/online.png' %}"
                            alt="{{ site_settings.site_name|default:'Logo (dark)' }}"
                            class="h-10 md:h-12 w-auto mr-2 hidden dark:block object-contain" />

                        <span>{{ site_settings.site_name|default:"Safari & Bush Retreats" }}</span>
                    </a>
                    
                    <!-- Mobile menu button -->
                    <button class="lg:hidden p-2 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark transition-colors duration-300" type="button" id="mobile-menu-toggle" aria-label="Toggle navigation">
                        <span class="block w-6 h-0.5 bg-gray-600 dark:bg-gray-300 mb-1 transition-all duration-300"></span>
                        <span class="block w-6 h-0.5 bg-gray-600 dark:bg-gray-300 mb-1 transition-all duration-300"></span>
                        <span class="block w-6 h-0.5 bg-gray-600 dark:bg-gray-300 transition-all duration-300"></span>
                    </button>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex items-center space-x-8">
                        <ul class="flex items-center space-x-6">
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'core:home' %}">Home</a>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'park_list' %}active{% endif %}" href="{% url 'parks:park_list' %}">National Parks</a>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'tour_list' %}active{% endif %}" href="{% url 'tours:tour_list' %}">Safari Tours</a>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'review_list' %}active{% endif %}" href="{% url 'reviews:review_list' %}">Reviews</a>
                            </li>
                            <li class="relative group">
                                <button class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 flex items-center {% if 'destination' in request.resolver_match.url_name or 'wildlife' in request.resolver_match.url_name or 'historical_sites' in request.resolver_match.url_name or 'guide' in request.resolver_match.url_name %}active{% endif %}" id="destinationsDropdown" aria-expanded="false">
                                    Destinations
                                    <i class="fas fa-chevron-down ml-1 text-xs group-hover:rotate-180 transition-transform duration-300"></i>
                                </button>
                                <div class="absolute top-full left-0 mt-2 w-80 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50">
                                    <div class="p-2">
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}">
                                            <i class="fas fa-map-marker-alt mr-3 w-4"></i>All Destinations
                                        </a>
                                        <hr class="my-2 border-gray-200 dark:border-gray-600">
                                        <h6 class="px-4 py-2 text-primary dark:text-primary-dark font-semibold text-sm">By Category</h6>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=wildlife_area">
                                            <i class="fas fa-paw mr-3 w-4"></i>Wildlife Areas
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=viewpoint">
                                            <i class="fas fa-mountain mr-3 w-4"></i>Viewpoints
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=waterfall">
                                            <i class="fas fa-tint mr-3 w-4"></i>Waterfalls
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=lake">
                                            <i class="fas fa-water mr-3 w-4"></i>Lakes
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=beach">
                                            <i class="fas fa-umbrella-beach mr-3 w-4"></i>Beaches
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:destination_list' %}?type=cultural_site">
                                            <i class="fas fa-users mr-3 w-4"></i>Cultural Sites
                                        </a>
                                        <hr class="my-2 border-gray-200 dark:border-gray-600">
                                        <h6 class="px-4 py-2 text-primary dark:text-primary-dark font-semibold text-sm">Special Collections</h6>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:wildlife_list' %}">
                                            <i class="fas fa-binoculars mr-3 w-4"></i>Wildlife Species
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'parks:wildlife_list' %}?big_five=true">
                                            <i class="fas fa-crown mr-3 w-4"></i>Big Five
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'core:historical_sites_list' %}">
                                            <i class="fas fa-landmark mr-3 w-4"></i>Historical Sites
                                        </a>
                                        {% comment %} <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'tours:guide_list' %}">
                                            <i class="fas fa-user-tie mr-3 w-4"></i>Tour Guides
                                        </a> {% endcomment %}
                                    </div>
                                </div>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'about' %}active{% endif %}" href="{% url 'core:about' %}">About</a>
                            </li>
                            <li>
                                <a class="nav-link-underline relative font-medium text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-all duration-300 hover:-translate-y-0.5 {% if request.resolver_match.url_name == 'contact' %}active{% endif %}" href="{% url 'core:contact' %}">Contact</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- FIXED: Mobile Navigation Menu with proper z-index and scrolling -->
                <div class="lg:hidden mobile-menu hidden bg-white dark:bg-gray-700 rounded-lg mt-4 p-4 shadow-2xl border border-gray-200 dark:border-gray-600 fixed left-4 right-4 top-8" id="mobile-menu">
                    <ul class="space-y-2">
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'core:home' %}">Home</a></li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'park_list' %}active{% endif %}" href="{% url 'parks:park_list' %}">National Parks</a></li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'tour_list' %}active{% endif %}" href="{% url 'tours:tour_list' %}">Safari Tours</a></li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'review_list' %}active{% endif %}" href="{% url 'reviews:review_list' %}">Reviews</a></li>
                        <!-- Mobile Destinations Dropdown -->
                        <li class="mobile-dropdown-container">
                            <button class="mobile-dropdown-toggle w-full flex items-center justify-between px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if 'destination' in request.resolver_match.url_name or 'wildlife' in request.resolver_match.url_name or 'historical_sites' in request.resolver_match.url_name or 'guide' in request.resolver_match.url_name %}active{% endif %}" 
                                    id="mobile-destinations-toggle" 
                                    aria-expanded="false" 
                                    aria-controls="mobile-destinations-menu">
                                <span class="font-medium">Destinations</span>
                                <i class="fas fa-chevron-down mobile-dropdown-icon transition-transform duration-300 text-sm"></i>
                            </button>
                            
                            <!-- FIXED: Mobile Destinations Submenu with better spacing -->
                            <div class="mobile-dropdown-menu hidden mt-2 ml-4 space-y-1 overflow-hidden transition-all duration-300" id="mobile-destinations-menu">
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.resolver_match.url_name == 'destination_list' and not request.GET.type %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}">
                                    <i class="fas fa-map-marker-alt mr-3 w-4 text-center"></i>
                                    <span>All Destinations</span>
                                    {% if request.resolver_match.url_name == 'destination_list' and not request.GET.type %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <!-- Category Divider -->
                                <div class="px-4 py-2">
                                    <hr class="border-gray-300 dark:border-gray-600">
                                    <h6 class="text-primary dark:text-primary-dark font-semibold text-sm mt-2 mb-1">By Category</h6>
                                </div>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'wildlife_area' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=wildlife_area">
                                    <i class="fas fa-paw mr-3 w-4 text-center"></i>
                                    <span>Wildlife Areas</span>
                                    {% if request.GET.type == 'wildlife_area' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'viewpoint' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=viewpoint">
                                    <i class="fas fa-mountain mr-3 w-4 text-center"></i>
                                    <span>Viewpoints</span>
                                    {% if request.GET.type == 'viewpoint' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'waterfall' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=waterfall">
                                    <i class="fas fa-tint mr-3 w-4 text-center"></i>
                                    <span>Waterfalls</span>
                                    {% if request.GET.type == 'waterfall' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'lake' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=lake">
                                    <i class="fas fa-water mr-3 w-4 text-center"></i>
                                    <span>Lakes</span>
                                    {% if request.GET.type == 'lake' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'beach' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=beach">
                                    <i class="fas fa-umbrella-beach mr-3 w-4 text-center"></i>
                                    <span>Beaches</span>
                                    {% if request.GET.type == 'beach' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.type == 'cultural_site' %}active{% endif %}" 
                                   href="{% url 'parks:destination_list' %}?type=cultural_site">
                                    <i class="fas fa-users mr-3 w-4 text-center"></i>
                                    <span>Cultural Sites</span>
                                    {% if request.GET.type == 'cultural_site' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <!-- Special Collections Divider -->
                                <div class="px-4 py-2">
                                    <hr class="border-gray-300 dark:border-gray-600">
                                    <h6 class="text-primary dark:text-primary-dark font-semibold text-sm mt-2 mb-1">Special Collections</h6>
                                </div>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.resolver_match.url_name == 'wildlife_list' and not request.GET.big_five %}active{% endif %}" 
                                   href="{% url 'parks:wildlife_list' %}">
                                    <i class="fas fa-binoculars mr-3 w-4 text-center"></i>
                                    <span>Wildlife Species</span>
                                    {% if request.resolver_match.url_name == 'wildlife_list' and not request.GET.big_five %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.GET.big_five == 'true' %}active{% endif %}" 
                                   href="{% url 'parks:wildlife_list' %}?big_five=true">
                                    <i class="fas fa-crown mr-3 w-4 text-center"></i>
                                    <span>Big Five</span>
                                    {% if request.GET.big_five == 'true' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.resolver_match.url_name == 'historical_sites_list' %}active{% endif %}" 
                                   href="{% url 'core:historical_sites_list' %}">
                                    <i class="fas fa-landmark mr-3 w-4 text-center"></i>
                                    <span>Historical Sites</span>
                                    {% if request.resolver_match.url_name == 'historical_sites_list' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a>
                                
                                {% comment %} <a class="mobile-dropdown-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 touch-manipulation min-h-[48px] {% if request.resolver_match.url_name == 'guide_list' %}active{% endif %}" 
                                   href="{% url 'tours:guide_list' %}">
                                    <i class="fas fa-user-tie mr-3 w-4 text-center"></i>
                                    <span>Tour Guides</span>
                                    {% if request.resolver_match.url_name == 'guide_list' %}
                                        <i class="fas fa-check ml-auto text-primary dark:text-primary-dark"></i>
                                    {% endif %}
                                </a> {% endcomment %}
                            </div>
                        </li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'about' %}active{% endif %}" href="{% url 'core:about' %}">About</a></li>
                        <li><a class="mobile-nav-link block px-4 py-3 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-colors duration-300 {% if request.resolver_match.url_name == 'contact' %}active{% endif %}" href="{% url 'core:contact' %}">Contact</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Secondary Row: Search, User Menu, Dark/Light Mode -->
        <nav class="bg-white dark:bg-gray-800 secondary-row py-1">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center w-full flex-col md:flex-row gap-4 md:gap-0">
                    <!-- Search Form -->
                    <form class="flex flex-1 max-w-lg min-w-0 w-full md:w-auto" method="GET" action="{% url 'core:search' %}">
                        <div class="flex w-full">
                            <input class="flex-1 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-l-lg text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark focus:border-transparent transition-all duration-300" type="search" name="q" placeholder="Search tours, parks..." value="{{ request.GET.q }}" aria-label="Search">
                            <button class="px-4 py-2 bg-primary dark:bg-primary-dark text-white border border-primary dark:border-primary-dark rounded-r-lg hover:bg-secondary dark:hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark transition-all duration-300 hover:-translate-y-0.5" type="submit" aria-label="Search button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                    
                    <!-- User Menu and Theme Toggle -->
                    <ul class="flex items-center space-x-4 w-full md:w-auto justify-center md:justify-end">
                        {% if user.is_authenticated %}
                            <li class="relative group">
                                <button class="flex items-center text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-colors duration-300 focus-primary" id="userDropdown" aria-expanded="false">
                                    <i class="fas fa-user mr-2"></i>
                                    <span class="md:inline">{{ user.get_display_name }}</span>
                                    <i class="fas fa-chevron-down ml-1 text-xs group-hover:rotate-180 transition-transform duration-300"></i>
                                </button>
                                <div class="absolute top-full right-0 mt-2 w-48 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50">
                                    <div class="p-2">
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'accounts:dashboard' %}">
                                            <i class="fas fa-tachometer-alt mr-3 w-4"></i>Dashboard
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'bookings:booking_list' %}">
                                            <i class="fas fa-calendar-check mr-3 w-4"></i>My Bookings
                                        </a>
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'accounts:profile_update' %}">
                                            <i class="fas fa-user-edit mr-3 w-4"></i>Profile
                                        </a>
                                        <hr class="my-2 border-gray-200 dark:border-gray-600">
                                        <a class="flex items-center px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-primary hover:text-white dark:hover:bg-primary-dark rounded-md transition-all duration-300 hover:translate-x-1" href="{% url 'accounts:logout' %}">
                                            <i class="fas fa-sign-out-alt mr-3 w-4"></i>Logout
                                        </a>
                                    </div>
                                </div>
                            </li>
                        {% else %}
                            <li>
                                <a class="text-gray-800 dark:text-gray-200 hover:text-primary dark:hover:text-primary-dark transition-colors duration-300 focus-primary" href="{% url 'accounts:login' %}">
                                    <i class="fas fa-sign-in-alt mr-1 md:hidden"></i>
                                    <span class="md:inline">Login</span>
                                </a>
                            </li>
                            <li>
                                <a class="inline-flex items-center px-4 py-2 bg-primary dark:bg-primary-dark text-white rounded-lg hover:bg-secondary dark:hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark transition-all duration-300 hover:-translate-y-0.5 text-sm font-medium" href="{% url 'accounts:register' %}">
                                    <i class="fas fa-user-plus mr-1 md:hidden"></i>
                                    <span class="md:inline">Sign Up</span>
                                </a>
                            </li>
                        {% endif %}
                        
                        <!-- Dark/Light Mode Toggle -->
                        <li>
                            <button id="theme-toggle" class="w-10 h-10 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-600 rounded-lg hover:text-primary hover:bg-primary hover:text-white dark:hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md flex items-center justify-center" title="Toggle Theme" aria-label="Toggle dark/light mode">
                                <i class="fas fa-moon text-lg" id="theme-icon"></i>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Messages -->
    {% if messages %}
        <div class="container mx-auto px-4 mt-2">
            {% for message in messages %}
                <div class="alert-enter flex items-center p-4 mb-4 rounded-lg border-l-4 {% if message.tags == 'success' %}bg-green-50 dark:bg-green-900/20 border-green-500 text-green-700 dark:text-green-400{% elif message.tags == 'error' or message.tags == 'danger' %}bg-red-50 dark:bg-red-900/20 border-red-500 text-red-700 dark:text-red-400{% elif message.tags == 'warning' %}bg-yellow-50 dark:bg-yellow-900/20 border-yellow-500 text-yellow-700 dark:text-yellow-400{% else %}bg-blue-50 dark:bg-blue-900/20 border-blue-500 text-blue-700 dark:text-blue-400{% endif %} transition-all duration-300" role="alert">
                    <i class="fas fa-info-circle mr-3"></i>
                    <span class="flex-1">{{ message }}</span>
                    <button type="button" class="ml-4 text-current hover:text-opacity-75 focus:outline-none focus:text-opacity-75 transition-colors duration-300" onclick="this.parentElement.remove()" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <main>
        {% block content %}
        
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-50 border-t border-white">
        <div class="container mx-auto max-w-7xl px-4 py-12">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-8">
            <!-- Brand / Description -->
            <div class="md:col-span-2">
                <h5 class="text-xl font-semibold text-[#C18D45] mb-3">{{ site_settings.site_name|default:"Safari & Bush Retreats" }}</h5>
                <p class="mb-4 text-sm text-gray-200">
                Experience the magic of Tanzania's wildlife and landscapes with our expert-guided safari tours. From the Serengeti to Kilimanjaro, we make your African dreams come true.
                </p>

                <div class="flex items-center space-x-4">
                {% if site_settings.facebook_url %}
                    <a href="{{ site_settings.facebook_url }}" class="text-gray-400 hover:text-[#C18D45] transition">
                    <i class="fab fa-facebook-f" aria-hidden="true"></i>
                    <span class="sr-only">Facebook</span>
                    </a>
                {% endif %}
                {% if site_settings.twitter_url %}
                    <a href="{{ site_settings.twitter_url }}" class="text-gray-400 hover:text-[#C18D45] transition">
                    <i class="fa-brands fa-x-twitter"></i>
                    <span class="sr-only">Twitter</span>
                    </a>
                {% endif %}
                {% if site_settings.instagram_url %}
                    <a href="{{ site_settings.instagram_url }}" class="text-gray-400 hover:text-[#C18D45] transition">
                    <i class="fab fa-instagram" aria-hidden="true"></i>
                    <span class="sr-only">Instagram</span>
                    </a>
                {% endif %}
                {% if site_settings.youtube_url %}
                    <a href="{{ site_settings.youtube_url }}" class="text-gray-400 hover:text-[#C18D45] transition">
                    <i class="fab fa-youtube" aria-hidden="true"></i>
                    <span class="sr-only">YouTube</span>
                    </a>
                {% endif %}
                </div>
            </div>

            <!-- Quick Links -->
            <div>
                <h6 class="text-sm font-semibold text-[#C18D45] mb-3">Quick Links</h6>
                <ul class="space-y-2 text-sm">
                <li><a href="{% url 'core:home' %}" class="hover:text-[#C18D45] transition">Home</a></li>
                <li><a href="{% url 'parks:park_list' %}" class="hover:text-[#C18D45] transition">National Parks</a></li>
                <li><a href="{% url 'tours:tour_list' %}" class="hover:text-[#C18D45] transition">Safari Tours</a></li>
                <li><a href="{% url 'core:about' %}" class="hover:text-[#C18D45] transition">About Us</a></li>
                <li><a href="{% url 'core:contact' %}" class="hover:text-[#C18D45] transition">Contact</a></li>
                </ul>
            </div>

            <!-- Destinations -->
            <div>
                <h6 class="text-sm font-semibold text-[#C18D45] mb-3">Destinations</h6>
                <ul class="space-y-2 text-sm">
                <li><a href="{% url 'parks:destination_list' %}" class="hover:text-[#C18D45] transition">All Destinations</a></li>
                <li><a href="{% url 'parks:wildlife_list' %}" class="hover:text-[#C18D45] transition">Wildlife</a></li>
                <li><a href="{% url 'core:historical_sites_list' %}" class="hover:text-[#C18D45] transition">Historical Sites</a></li>
                <li><a href="{% url 'parks:park_list' %}" class="hover:text-[#C18D45] transition">National Parks</a></li>
                </ul>
            </div>

            <!-- Support -->
            <div>
                <h6 class="text-sm font-semibold text-[#C18D45] mb-3">Support</h6>
                <ul class="space-y-2 text-sm">
                <li><a href="{% url 'core:faq' %}" class="hover:text-[#C18D45] transition">FAQ</a></li>
                <li><a href="{% url 'core:privacy_policy' %}" class="hover:text-[#C18D45] transition">Privacy Policy</a></li>
                <li><a href="{% url 'core:terms_of_service' %}" class="hover:text-[#C18D45] transition">Terms of Service</a></li>
                <li><a href="#" class="hover:text-[#C18D45] transition">Travel Insurance</a></li>
                <li><a href="#" class="hover:text-[#C18D45] transition">Visa Information</a></li>
                </ul>
            </div>

            <!-- Contact Info -->
            <div>
                <h6 class="text-sm font-semibold text-[#C18D45] mb-3">Contact Info</h6>
                <ul class="space-y-2 text-sm text-gray-400">
                    <li class="flex items-start">
                        <i class="fas fa-phone mr-2 mt-0.5" aria-hidden="true"></i>
                        <span>{{ site_settings.contact_phone|default:"+255 768 373 033" }}</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-envelope mr-2 mt-0.5" aria-hidden="true"></i>
                        <span>{{ site_settings.contact_email|default:"safariandbushretreats@gmail.com" }}</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-map-marker-alt mr-2 mt-0.5" aria-hidden="true"></i>
                        <span>{{ site_settings.address|default:"Iringa, Tanzania" }}</span>
                    </li>
                </ul>
            </div>
            </div>

            <div class="border-t border-gray-200 mt-8 pt-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3 text-sm text-gray-500">
                <p class="mb-0">&copy; 2024 {{ site_settings.site_name|default:"Safari & Bush Retreats" }}. All rights reserved.</p>
                <p class="mb-0">Made with <i class="fas fa-heart text-[#C18D45] mx-1" aria-hidden="true"></i> in Tanzania</p>
            </div>
            </div>
        </div>
    </footer>

    <!-- ENHANCED JavaScript with all fixes -->
    <script>
        // FIXED: Theme Management System with better persistence
        class ThemeManager {
            constructor() {
                this.themeToggle = document.getElementById('theme-toggle');
                this.themeIcon = document.getElementById('theme-icon');
                // FIXED: Better theme detection and persistence
                this.currentTheme = this.getInitialTheme();
                
                this.init();
            }

            getInitialTheme() {
                // Check localStorage first
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    return savedTheme;
                }
                
                // Check system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    return 'dark';
                }
                
                return 'light';
            }

            init() {
                // Set initial theme immediately
                this.setTheme(this.currentTheme);
                
                // Add event listener
                this.themeToggle.addEventListener('click', () => this.toggleTheme());
                
                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    // Only follow system if user hasn't manually set theme
                    if (!localStorage.getItem('theme')) {
                        this.setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            }

            setTheme(theme) {
                this.currentTheme = theme;
                // Apply theme immediately
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                // Save to localStorage for persistence across pages
                localStorage.setItem('theme', theme);
                this.updateThemeIcon();
            }

            toggleTheme() {
                const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                this.setTheme(newTheme);
                
                // Add click animation
                this.themeToggle.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    this.themeToggle.style.transform = 'scale(1)';
                }, 150);
            }

            updateThemeIcon() {
                const icon = this.currentTheme === 'light' ? 'fa-moon' : 'fa-sun';
                this.themeIcon.className = `fas ${icon} text-lg`;
                
                // Update tooltip
                this.themeToggle.title = this.currentTheme === 'light' ? 'Switch to dark mode' : 'Switch to light mode';
            }
        }

        // FIXED: Header Scroll Behavior - less aggressive hiding
        class HeaderManager {
            constructor({
                scrollThreshold = 150, // px to start hiding when scrolling down
                delta = 10             // minimum change to consider (prevents jitter)
            } = {}) {
                this.header = document.querySelector('.header');
                if (!this.header) return;

                this.scrollThreshold = scrollThreshold;
                this.delta = delta;

                // initialize to current scroll position (handles page loads not at top)
                this.lastScrollTop = window.pageYOffset || document.documentElement.scrollTop || 0;
                this.latestScroll = this.lastScrollTop;
                this.ticking = false;

                this.init();
            }

            init() {
                // Use passive listener for best performance
                window.addEventListener('scroll', () => this.onScroll(), { passive: true });

                // Also reveal header when user moves mouse near top (useful on desktop)
                window.addEventListener('mousemove', (e) => {
                    if (e.clientY < 80) {
                        this.showHeader();
                    }
                }, { passive: true });

                // Optional: reveal when user uses keyboard (PageUp, ArrowUp, Home)
                window.addEventListener('keydown', (e) => {
                    if (['ArrowUp', 'PageUp', 'Home'].includes(e.key)) {
                        this.showHeader();
                    }
                });
            }

            onScroll() {
                this.latestScroll = window.pageYOffset || document.documentElement.scrollTop || 0;
                if (!this.ticking) {
                    this.ticking = true;
                    requestAnimationFrame(() => this.handleScroll());
                }
            }

            handleScroll() {
                const scrollTop = this.latestScroll;

                // ignore very small movements
                if (Math.abs(scrollTop - this.lastScrollTop) <= this.delta) {
                    this.ticking = false;
                    return;
                }

                const isScrollingDown = scrollTop > this.lastScrollTop;

                if (isScrollingDown && scrollTop > this.scrollThreshold) {
                    // hide secondary row when scrolling down past threshold
                    if (!this.header.classList.contains('header-scrolled')) {
                        this.header.classList.add('header-scrolled');
                    }
                } else {
                    // reveal when scrolling up (or near top)
                    if (this.header.classList.contains('header-scrolled')) {
                        this.header.classList.remove('header-scrolled');
                    }
                }

                // store for next tick
                this.lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
                this.ticking = false;
            }

            // helper to force-show header (used by mouse/keyboard handlers)
            showHeader() {
                if (this.header && this.header.classList.contains('header-scrolled')) {
                    this.header.classList.remove('header-scrolled');
                    // update lastScrollTop so the next scroll direction check is correct
                    this.lastScrollTop = window.pageYOffset || document.documentElement.scrollTop || 0;
                }
            }
        }

        // FIXED: Mobile Menu Manager with better dropdown handling
        class MobileMenuManager {
            constructor() {
                this.menuToggle = document.getElementById('mobile-menu-toggle');
                this.mobileMenu = document.getElementById('mobile-menu');
                this.destinationsToggle = document.getElementById('mobile-destinations-toggle');
                this.destinationsMenu = document.getElementById('mobile-destinations-menu');
                this.isOpen = false;
                this.isDestinationsOpen = false;
                
                this.init();
            }

            init() {
                this.menuToggle.addEventListener('click', () => this.toggleMenu());
                
                // Initialize destinations dropdown
                if (this.destinationsToggle && this.destinationsMenu) {
                    this.destinationsToggle.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.toggleDestinations();
                    });
                }
                
                // FIXED: Better click outside handling
                document.addEventListener('click', (e) => {
                    if (this.isOpen && 
                        !this.menuToggle.contains(e.target) && 
                        !this.mobileMenu.contains(e.target)) {
                        this.closeMenu();
                    }
                });
                
                // Handle touch events for better mobile experience
                this.setupTouchEvents();
            }

            toggleMenu() {
                if (this.isOpen) {
                    this.closeMenu();
                } else {
                    this.openMenu();
                }
            }

            openMenu() {
                this.mobileMenu.classList.remove('hidden');
                this.isOpen = true;
                this.animateToggler(true);
                
                // FIXED: Don't lock scroll, just ensure menu is visible
            }

            closeMenu() {
                this.mobileMenu.classList.add('hidden');
                this.isOpen = false;
                this.animateToggler(false);
                
                // Close destinations dropdown if open
                if (this.isDestinationsOpen) {
                    this.closeDestinations();
                }
            }

            animateToggler(isOpen) {
                const spans = this.menuToggle.querySelectorAll('span');

                if (isOpen) {
                    spans[0].style.transformOrigin = "center";
                    spans[2].style.transformOrigin = "center";

                    // Adjust the translateY to exactly meet in center
                    spans[0].style.transform = 'translateY(6px) rotate(45deg)';
                    spans[1].style.opacity = '0';
                    spans[2].style.transform = 'translateY(-6px) rotate(-45deg)';
                } else {
                    spans[0].style.transform = 'translateY(0) rotate(0)';
                    spans[1].style.opacity = '1';
                    spans[2].style.transform = 'translateY(0) rotate(0)';
                }
            }
            
            toggleDestinations() {
                if (this.isDestinationsOpen) {
                    this.closeDestinations();
                } else {
                    this.openDestinations();
                }
            }
            
            openDestinations() {
                this.destinationsMenu.classList.remove('hidden');
                this.destinationsMenu.classList.add('show');
                this.destinationsToggle.setAttribute('aria-expanded', 'true');
                this.isDestinationsOpen = true;
                
                // Add haptic feedback on supported devices
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            }
            
            closeDestinations() {
                this.destinationsMenu.classList.remove('show');
                this.destinationsToggle.setAttribute('aria-expanded', 'false');
                this.isDestinationsOpen = false;
                
                // Hide after animation completes
                setTimeout(() => {
                    if (!this.isDestinationsOpen) {
                        this.destinationsMenu.classList.add('hidden');
                    }
                }, 400); // FIXED: Increased timeout to match CSS transition
            }
            
            setupTouchEvents() {
                // Add touch feedback for dropdown items
                const dropdownItems = document.querySelectorAll('.mobile-dropdown-item');
                
                dropdownItems.forEach(item => {
                    let touchStartTime;
                    let touchStartY;
                    
                    item.addEventListener('touchstart', (e) => {
                        touchStartTime = Date.now();
                        touchStartY = e.touches[0].clientY;
                        item.style.backgroundColor = 'rgba(193, 141, 69, 0.1)';
                    }, { passive: true });
                    
                    item.addEventListener('touchend', (e) => {
                        const touchDuration = Date.now() - touchStartTime;
                        const touchEndY = e.changedTouches[0].clientY;
                        const touchDistance = Math.abs(touchEndY - touchStartY);
                        
                        // Reset background after a short delay
                        setTimeout(() => {
                            item.style.backgroundColor = '';
                        }, 150);
                        
                        // FIXED: Better tap detection - check both duration and distance
                        if (touchDuration < 300 && touchDistance < 10) {
                            const href = item.getAttribute('href');
                            if (href && href !== '#') {
                                // Add small delay for visual feedback
                                setTimeout(() => {
                                    window.location.href = href;
                                }, 100);
                            }
                        }
                    }, { passive: true });
                    
                    item.addEventListener('touchcancel', () => {
                        item.style.backgroundColor = '';
                    }, { passive: true });
                });
                
                // Add touch feedback for main toggle
                if (this.destinationsToggle) {
                    this.destinationsToggle.addEventListener('touchstart', () => {
                        this.destinationsToggle.style.backgroundColor = 'rgba(193, 141, 69, 0.1)';
                    }, { passive: true });
                    
                    this.destinationsToggle.addEventListener('touchend', () => {
                        setTimeout(() => {
                            this.destinationsToggle.style.backgroundColor = '';
                        }, 150);
                    }, { passive: true });
                }
            }
        }

        // Alert Management
        class AlertManager {
            constructor() {
                this.init();
            }

            init() {
                // Auto-hide alerts after 5 seconds
                this.autoHideAlerts();
            }

            autoHideAlerts() {
                setTimeout(() => {
                    const alerts = document.querySelectorAll('.alert-enter:not(.alert-permanent)');
                    alerts.forEach(alert => {
                        alert.classList.add('alert-exit');
                        setTimeout(() => alert.remove(), 300);
                    });
                }, 5000);
            }
        }

        // Search Enhancement
        class SearchManager {
            constructor() {
                this.searchInput = document.querySelector('input[name="q"]');
                this.init();
            }

            init() {
                if (this.searchInput) {
                    this.searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.searchInput.closest('form').submit();
                        }
                    });
                }
            }
        }

        // FIXED: Initialize all managers when DOM is loaded with proper error handling
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Initialize theme first for immediate application
                new ThemeManager();
                new HeaderManager();
                new MobileMenuManager();
                new AlertManager();
                new SearchManager();

                // Smooth scroll for anchor links
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        e.preventDefault();
                        const target = document.querySelector(this.getAttribute('href'));
                        if (target) {
                            target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    });
                });
            } catch (error) {
                console.error('Error initializing page components:', error);
            }
        });

        // FIXED: Newsletter function with better error handling
        function subscribeNewsletter() {
            const emailInput = document.getElementById('newsletter-email');
            if (!emailInput) {
                console.error('Newsletter email input not found');
                return;
            }
            
            const email = emailInput.value.trim();
            if (!email) {
                alert('Please enter your email address');
                return;
            }
            
            if (!email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            fetch('{% url "core:newsletter_signup" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: 'email=' + encodeURIComponent(email)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    emailInput.value = '';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
