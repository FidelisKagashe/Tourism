{% extends 'base/base.html' %}
{% load i18n crispy_forms_tags static %}

{% block title %}{% trans "Book" %} {{ tour_package.title }} - Safari & Bush Retreats{% endblock %}

{% block extra_css %}
<style>
  /* progress connectors (Tailwind handles colors; this draws the lines) */
  .progress-wrap .step:not(:last-child) .connector{
    position:absolute; top:22px; left:calc(50% + 26px); right:-50%; height:2px;
  }
</style>
{% endblock %}

{% block content %}
<div class="booking-scope">

  <section class="container mx-auto px-4 py-6 lg:py-10">

    <!-- Progress -->
    <div class="progress-wrap relative flex items-center justify-between mb-8">
      {% comment %} Step 1 active {% endcomment %}
      <div class="step relative flex-1 text-center">
        <div class="mx-auto w-11 h-11 rounded-full grid place-items-center shadow-md
                    bg-[#C18D45] text-white font-bold">1</div>
        <div class="mt-2 text-sm font-semibold text-gray-900 dark:text-gray-100">{% trans "Tour Details" %}</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">{% trans "Choose options" %}</div>
        <span class="connector bg-[#C18D45]"></span>
      </div>

      <div class="step relative flex-1 text-center">
        <div class="mx-auto w-11 h-11 rounded-full grid place-items-center shadow
                    bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-100 font-bold">2</div>
        <div class="mt-2 text-sm font-semibold text-gray-900 dark:text-gray-100">{% trans "Participants" %}</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">{% trans "Traveler info" %}</div>
        <span class="connector bg-gray-200 dark:bg-gray-700"></span>
      </div>

      <div class="step relative flex-1 text-center">
        <div class="mx-auto w-11 h-11 rounded-full grid place-items-center shadow
                    bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-100 font-bold">3</div>
        <div class="mt-2 text-sm font-semibold text-gray-900 dark:text-gray-100">{% trans "Payment" %}</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">{% trans "Secure checkout" %}</div>
        <span class="connector bg-gray-200 dark:bg-gray-700"></span>
      </div>

      <div class="step relative flex-1 text-center">
        <div class="mx-auto w-11 h-11 rounded-full grid place-items-center shadow
                    bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-100 font-bold">4</div>
        <div class="mt-2 text-sm font-semibold text-gray-900 dark:text-gray-100">{% trans "Confirmation" %}</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">{% trans "Youâ€™re set!" %}</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">

      <!-- Left: Form -->
      <div class="lg:col-span-8">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow border border-gray-100 dark:border-gray-800 overflow-hidden">
          <div class="px-5 py-4 border-b border-gray-100 dark:border-gray-800 flex items-center gap-2">
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold
                         bg-amber-50 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200 border border-amber-200/60">
              <i class="fas fa-shield-alt mr-1"></i> {% trans "Request" %}
            </span>
            <h1 class="text-lg md:text-xl font-bold text-gray-900 dark:text-gray-100 m-0">
              {% trans "Book Your Safari" %}
            </h1>
          </div>

          <div class="p-5 md:p-6">
            <form method="post" id="bookingForm" class="space-y-8">
              {% csrf_token %}

              <!-- Info alert -->
              <div class="rounded-xl border border-blue-200/60 dark:border-blue-800/60 p-4
                          bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-100">
                <p class="text-sm md:text-[0.95rem]">
                  <i class="fas fa-info-circle mr-2"></i>
                  <strong>{% trans "Booking Process:" %}</strong>
                  {% trans "Submit your booking request and our team will contact you within 24 hours to confirm details and discuss payment options." %}
                </p>
              </div>

              <!-- Tour Selection -->
              <section>
                <h2 class="text-base md:text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">
                  {% trans "Tour Selection" %}
                </h2>
                <div class="space-y-4">
                  {% crispy form %}
                </div>
              </section>

              <!-- Participants -->
              <section>
                <h2 class="text-base md:text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">
                  {% trans "Participant Information" %}
                </h2>

                <div id="participant-forms" class="space-y-3">
                  {{ participant_formset.management_form }}
                  {% for form in participant_formset %}
                    <div class="participant-form rounded-xl border border-dashed border-gray-200 dark:border-gray-700 p-4">
                      <h3 class="text-sm font-bold text-gray-800 dark:text-gray-200 mb-3">
                        {% trans "Participant" %} {{ forloop.counter }}
                      </h3>
                      {% crispy form %}
                    </div>
                  {% endfor %}
                </div>

                <button type="button"
                        id="add-participant"
                        class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-lg
                               border border-gray-300 dark:border-gray-600
                               text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800
                               hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                  <i class="fas fa-plus"></i> {% trans "Add Participant" %}
                </button>
              </section>

              <div class="flex items-center justify-end">
                <button type="submit"
                        class="inline-flex items-center gap-2 px-5 py-3 rounded-xl font-semibold
                               bg-[#C18D45] hover:bg-[#a97a3a] text-white shadow
                               focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#C18D45]">
                  <i class="fas fa-paper-plane"></i> {% trans "Submit Booking Request" %}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Right: Summary -->
      <aside class="lg:col-span-4">
        <div class="sticky top-6">
          <div class="bg-white dark:bg-gray-900 rounded-2xl shadow border border-gray-100 dark:border-gray-800 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 dark:border-gray-800">
              <h2 class="text-base md:text-lg font-semibold text-gray-900 dark:text-gray-100 m-0">
                {% trans "Booking Summary" %}
              </h2>
            </div>

            <div class="p-5 space-y-5">
              <!-- Tour info -->
              <div class="flex items-center">
                <img src="{% if tour_package.main_image %}{{ tour_package.main_image.url }}{% else %}{% static 'images/tours/default.jpg' %}{% endif %}"
                     alt="{{ tour_package.title }}"
                     class="thumb mr-3">
                <div>
                  <p class="font-semibold text-gray-900 dark:text-gray-100 m-0">{{ tour_package.title }}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 m-0">{{ tour_package.get_duration_display }}</p>
                </div>
              </div>

              <div class="border-t border-dashed border-gray-200 dark:border-gray-700 pt-4 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-gray-600 dark:text-gray-300">{% trans "Participants" %}</span>
                  <span id="participant-count" class="font-semibold text-gray-900 dark:text-gray-100">1</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-600 dark:text-gray-300">{% trans "Accommodation" %}</span>
                  <span id="accommodation-type" class="font-semibold text-gray-900 dark:text-gray-100">{% trans "Standard" %}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-600 dark:text-gray-300">{% trans "Category" %}</span>
                  <span class="font-semibold text-gray-900 dark:text-gray-100">{{ tour_package.get_category_display }}</span>
                </div>
              </div>

              <div class="rounded-xl border border-blue-200/60 dark:border-blue-800/60 p-3
                          bg-blue-50 dark:bg-blue-900/30 text-xs text-blue-800 dark:text-blue-100">
                <i class="fas fa-info-circle mr-2"></i>
                {% trans "Our team will contact you with pricing details and payment options" %}
              </div>
            </div>
          </div>
        </div>
      </aside>

    </div>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('bookingForm');
  const participantCountEl = document.getElementById('participant-count');
  const accommodationTypeEl = document.getElementById('accommodation-type');

  function updateSummary() {
    const pEl = document.getElementById('id_number_of_participants');
    const aEl = document.getElementById('id_accommodation_type');
    const participants = (pEl && pEl.value) ? pEl.value : 1;
    const accommodation = (aEl && aEl.value) ? aEl.value : 'standard';
    participantCountEl.textContent = participants;
    accommodationTypeEl.textContent = accommodation.charAt(0).toUpperCase() + accommodation.slice(1);
  }

  if (form) {
    form.addEventListener('change', updateSummary);
    updateSummary();
  }

  const addBtn = document.getElementById('add-participant');
  if (addBtn) {
    addBtn.addEventListener('click', function () {
      alert('{% trans "Please specify the number of participants in the form above" %}');
    });
  }
});
</script>
{% endblock %}
